<!DOCTYPE>
<html>
    <head>
        <title>Game</title>
        <script type="application/javascript" src="game.js"></script>
    </head>
    <body>
        <canvas id="board" width="640" height="480"></canvas>
        <script type="application/javascript">
        
        var game = new Game();
            
        var url = "{{.}}";
        var connection = new WebSocket("ws://"+url+"/ws")
        
        
        
        connection.onmessage = function(event){
            var cmd = JSON.parse(event.data);
            
            if(cmd.id === -1){
                var s = window.atob(cmd.v);
                console.log(s);    
            }
            
            if(cmd.id === 0){
                var s = JSON.parse(window.atob(cmd.v))
                game.player = s;
                console.log(s)
            }
            
        }
        
        connection.onclose = function(){
            console.log("closed");
        }
        
        
         
        
        var input = game.input;
        
        document.body.addEventListener("keydown", function(event){
            var code = event.keyCode;
            if(code === 39 || code === 37){
                event.preventDefault();
                return false;
            }
        });
            
        document.body.addEventListener("keyup", function(event){
            var code = event.keyCode;
            
            if(code === 39){
                var cmd = {Id:1,Value:window.btoa("1")};
                connection.send(JSON.stringify(cmd));
                input.right();
            }
            
            if(code === 37){
                var cmd = {Id:1,Value:window.btoa("-1")};
                connection.send(JSON.stringify(cmd));
                input.left();
            }
            event.preventDefault();
            return false;
        });
            
        var ctx = document.getElementById("board").getContext("2d");
        
            
        (function animloop(){
            requestAnimFrame(animloop);
            game.tick();
            game.render(ctx);
        })();
        </script>
    </body>
    
</html>